(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory(require("knockout")):typeof define==="function"&&define.amd?define("ko-component-router",["knockout"],factory):(global.ko=global.ko||{},global.ko.router=factory(global.ko))})(this,function(ko){"use strict";ko="default"in ko?ko["default"]:ko;var index$1=function isObject(val){return val!=null&&typeof val==="object"&&!Array.isArray(val)};var isObject=index$1;function isObjectObject(o){return isObject(o)===true&&Object.prototype.toString.call(o)==="[object Object]"}var index=function isPlainObject(o){var ctor,prot;if(isObjectObject(o)===false)return false;ctor=o.constructor;if(typeof ctor!=="function")return false;prot=ctor.prototype;if(isObjectObject(prot)===false)return false;if(prot.hasOwnProperty("isPrototypeOf")===false){return false}return true};function isArray(arr){return typeof arr.splice==="function"}function isBool(x){return typeof x==="boolean"}function isPlainObject(x){return index(x)}function isString(x){return typeof x==="string"}function isFunction(x){return typeof x==="function"}function isUndefined(x){return typeof x==="undefined"}function flatMap(arr,fn){return arr.reduce(function(flattened,x){var v=fn(x);return flattened.concat(isArray(v)?v:[v])},[])}function runMiddleware(callbacks){var this$1=this;var args=[],len=arguments.length-1;while(len-- >0)args[len]=arguments[len+1];var downstream=[];callbacks=callbacks.map(function(fn){var runner=generatorify(fn).apply(void 0,args);var run=function(){return new Promise(function($return,$error){var ret;ret=runner.next();return new Promise(function($return,$error){if(isThenable(ret)){return ret.then($return,$error)}return $return(ret.value)}.bind(this)).then(function($await_18){try{ret=$await_18;return $return(ret||true)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}.bind(this$1))};downstream.push(run);return run});return[sequence.apply(void 0,[callbacks].concat(args)),function(){return sequence.apply(void 0,[downstream].concat(args))}]}function sequence(callbacks){var args=[],len=arguments.length-1;while(len-- >0)args[len]=arguments[len+1];return new Promise(function($return,$error){{var _fn,$iterator_fn_8=[callbacks[Symbol.iterator]()];var $Loop_9_trampoline;return($Loop_9_trampoline=function(q){var this$1=this;while(q){if(q.then){return void q.then($Loop_9_trampoline,$error)}try{if(q.pop){if(q.length){return q.pop()?$Loop_9_exit.call(this$1):q}else{q=$Loop_9}}else{q=q.call(this$1)}}catch(_exception){return $error(_exception)}}}.bind(this))($Loop_9);function $Loop_9(){if(!($iterator_fn_8[1]=$iterator_fn_8[0].next()).done&&((_fn=$iterator_fn_8[1].value)||true)){return promisify(_fn).apply(void 0,args).then(function($await_19){try{if($await_19===false){return $return(false)}return $Loop_9}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}else{return[1]}}}function $Loop_9_exit(){return $return()}}.bind(this))}function isGenerator(x){return x.constructor.name==="GeneratorFunction"}function isThenable(x){return!isUndefined(x)&&isFunction(x.then)}function generatorify(fn){return isGenerator(fn)?fn:function(){var args=[],len=arguments.length;while(len--)args[len]=arguments[len];var count=1,ret;return{next:function next(){return new Promise(function($return,$error){switch(count++){case 1:return promisify(fn).apply(void 0,args).then(function($await_20){try{ret=$await_20||false;return new Promise(function($return,$error){if(ret&&ret.beforeRender){return promisify(ret.beforeRender)().then($return,$error)}return $return(ret)}.bind(this)).then($return,$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error);case 2:return new Promise(function($return,$error){var $logicalAnd_1;if($logicalAnd_1=ret){return promisify(ret.afterRender)().then(function($await_23){try{$logicalAnd_1=$await_23;return $If_13.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_13(){return $return($logicalAnd_1)}return $If_13.call(this)}.bind(this)).then($return,$error);case 3:return new Promise(function($return,$error){var $logicalAnd_2;if($logicalAnd_2=ret){return promisify(ret.beforeDispose)().then(function($await_25){try{$logicalAnd_2=$await_25;return $If_14.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_14(){return $return($logicalAnd_2)}return $If_14.call(this)}.bind(this)).then($return,$error);case 4:return new Promise(function($return,$error){var $logicalAnd_3;if($logicalAnd_3=ret){return promisify(ret.afterDispose)().then(function($await_27){try{$logicalAnd_3=$await_27;return $If_15.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_15(){return $return($logicalAnd_3)}return $If_15.call(this)}.bind(this)).then($return,$error)}return $return()}.bind(this))}}}}function promisify(_fn){var this$1=this;if(_fn===void 0)_fn=function(){};return function(){var args=[],len=arguments.length;while(len--)args[len]=arguments[len];return new Promise(function($return,$error){var fn,ret;fn=function(){return _fn.length===args.length+1?new Promise(function(r){_fn.apply(void 0,args.concat([r]))}):_fn.apply(void 0,args)};ret=fn();return new Promise(function($return,$error){if(isThenable(ret)){return ret.then($return,$error)}return $return(ret)}.bind(this)).then($return,$error)}.bind(this$1))}}var Context=function Context(params){Object.assign(this,params);this.fullPath=this.router.base+this.pathname;this.canonicalPath=this.fullPath.replace(new RegExp(this.router.$root.base,"i"),"");this._queue=[];this._beforeNavigateCallbacks=[];this._afterRenderCallbacks=[];this._beforeDisposeCallbacks=[];this._afterDisposeCallbacks=[]};var prototypeAccessors$1={$parent:{},$parents:{},$child:{},$children:{},element:{}};Context.prototype.addBeforeNavigateCallback=function addBeforeNavigateCallback(cb){this._beforeNavigateCallbacks.unshift(cb)};prototypeAccessors$1.$parent.get=function(){return this.router.isRoot?undefined:this.router.$parent.ctx};prototypeAccessors$1.$parents.get=function(){return this.router.$parents.map(function(r){return r.ctx})};prototypeAccessors$1.$child.get=function(){return isUndefined(this.router.$child)?undefined:this.router.$child.ctx};prototypeAccessors$1.$children.get=function(){return this.router.$children.map(function(r){return r.ctx})};prototypeAccessors$1.element.get=function(){return document.getElementsByClassName("ko-component-router-view")[this.router.depth]};Context.prototype.runBeforeNavigateCallbacks=function runBeforeNavigateCallbacks(){return new Promise(function($return,$error){var ctx,callbacks;ctx=this;callbacks=[];while(ctx){callbacks=ctx._beforeNavigateCallbacks.concat(callbacks);ctx=ctx.$child}return sequence(callbacks).then($return,$error)}.bind(this))};Context.prototype.queue=function queue(promise){this._queue.push(promise)};Context.prototype.flushQueue=function flushQueue(){return new Promise(function($return,$error){var this$1=this;return $return(Promise.all(this._queue).then(function(){return this$1._queue=[]}))}.bind(this))};Context.prototype.runBeforeRender=function runBeforeRender(){return new Promise(function($return,$error){var appBeforeRender,appDownstream,routeBeforeRender,routeDownstream;var assign;assign=runMiddleware(Router$1.middleware,this),appBeforeRender=assign[0],appDownstream=assign[1];this._afterRenderCallbacks.push(appDownstream);this._beforeDisposeCallbacks.push(appDownstream);this._afterDisposeCallbacks.push(appDownstream);return appBeforeRender.then(function($await_3){try{var assign;assign=runMiddleware(this.route.middleware,this),routeBeforeRender=assign[0],routeDownstream=assign[1];this._afterRenderCallbacks.push(routeDownstream);this._beforeDisposeCallbacks.unshift(routeDownstream);this._afterDisposeCallbacks.unshift(routeDownstream);return routeBeforeRender.then(function($await_4){try{return this.flushQueue().then(function($await_5){try{return $return()}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}.bind(this))};Context.prototype.runAfterRender=function runAfterRender(){return new Promise(function($return,$error){return sequence(this._afterRenderCallbacks).then(function($await_6){try{return this.flushQueue().then(function($await_7){try{return $return()}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}.bind(this))};Context.prototype.runBeforeDispose=function runBeforeDispose(){return new Promise(function($return,$error){if(this.$child){return this.$child.runBeforeDispose().then(function($await_8){try{return $If_1.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_1(){return sequence(this._beforeDisposeCallbacks).then(function($await_9){try{return this.flushQueue().then(function($await_10){try{return $return()}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}return $If_1.call(this)}.bind(this))};Context.prototype.runAfterDispose=function runAfterDispose(){return new Promise(function($return,$error){return sequence(this._afterDisposeCallbacks).then(function($await_11){try{return this.flushQueue().then(function($await_12){try{return $return()}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}.bind(this))};Object.defineProperties(Context.prototype,prototypeAccessors$1);var index$4=Array.isArray||function(arr){return Object.prototype.toString.call(arr)=="[object Array]"};var isarray=index$4;var index$3=pathToRegexp;var parse_1=parse;var compile_1=compile;var tokensToFunction_1=tokensToFunction;var tokensToRegExp_1=tokensToRegExp;var PATH_REGEXP=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");function parse(str,options){var tokens=[];var key=0;var index=0;var path="";var defaultDelimiter=options&&options.delimiter||"/";var res;while((res=PATH_REGEXP.exec(str))!=null){var m=res[0];var escaped=res[1];var offset=res.index;path+=str.slice(index,offset);index=offset+m.length;if(escaped){path+=escaped[1];continue}var next=str[index];var prefix=res[2];var name=res[3];var capture=res[4];var group=res[5];var modifier=res[6];var asterisk=res[7];if(path){tokens.push(path);path=""}var partial=prefix!=null&&next!=null&&next!==prefix;var repeat=modifier==="+"||modifier==="*";var optional=modifier==="?"||modifier==="*";var delimiter=res[2]||defaultDelimiter;var pattern=capture||group;tokens.push({name:name||key++,prefix:prefix||"",delimiter:delimiter,optional:optional,repeat:repeat,partial:partial,asterisk:!!asterisk,pattern:pattern?escapeGroup(pattern):asterisk?".*":"[^"+escapeString(delimiter)+"]+?"})}if(index<str.length){path+=str.substr(index)}if(path){tokens.push(path)}return tokens}function compile(str,options){return tokensToFunction(parse(str,options))}function encodeURIComponentPretty(str){return encodeURI(str).replace(/[\/?#]/g,function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})}function encodeAsterisk(str){return encodeURI(str).replace(/[?#]/g,function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})}function tokensToFunction(tokens){var matches=new Array(tokens.length);for(var i=0;i<tokens.length;i++){if(typeof tokens[i]==="object"){matches[i]=new RegExp("^(?:"+tokens[i].pattern+")$")}}return function(obj,opts){var path="";var data=obj||{};var options=opts||{};var encode=options.pretty?encodeURIComponentPretty:encodeURIComponent;for(var i=0;i<tokens.length;i++){var token=tokens[i];if(typeof token==="string"){path+=token;continue}var value=data[token.name];var segment;if(value==null){if(token.optional){if(token.partial){path+=token.prefix}continue}else{throw new TypeError('Expected "'+token.name+'" to be defined')}}if(isarray(value)){if(!token.repeat){throw new TypeError('Expected "'+token.name+'" to not repeat, but received `'+JSON.stringify(value)+"`")}if(value.length===0){if(token.optional){continue}else{throw new TypeError('Expected "'+token.name+'" to not be empty')}}for(var j=0;j<value.length;j++){segment=encode(value[j]);if(!matches[i].test(segment)){throw new TypeError('Expected all "'+token.name+'" to match "'+token.pattern+'", but received `'+JSON.stringify(segment)+"`")}path+=(j===0?token.prefix:token.delimiter)+segment}continue}segment=token.asterisk?encodeAsterisk(value):encode(value);if(!matches[i].test(segment)){throw new TypeError('Expected "'+token.name+'" to match "'+token.pattern+'", but received "'+segment+'"')}path+=token.prefix+segment}return path}}function escapeString(str){return str.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function escapeGroup(group){return group.replace(/([=!:$\/()])/g,"\\$1")}function attachKeys(re,keys){re.keys=keys;return re}function flags(options){return options.sensitive?"":"i"}function regexpToRegexp(path,keys){var groups=path.source.match(/\((?!\?)/g);if(groups){for(var i=0;i<groups.length;i++){keys.push({name:i,prefix:null,delimiter:null,optional:false,repeat:false,partial:false,asterisk:false,pattern:null})}}return attachKeys(path,keys)}function arrayToRegexp(path,keys,options){var parts=[];for(var i=0;i<path.length;i++){parts.push(pathToRegexp(path[i],keys,options).source)}var regexp=new RegExp("(?:"+parts.join("|")+")",flags(options));return attachKeys(regexp,keys)}function stringToRegexp(path,keys,options){return tokensToRegExp(parse(path,options),keys,options)}function tokensToRegExp(tokens,keys,options){if(!isarray(keys)){options=keys||options;keys=[]}options=options||{};var strict=options.strict;var end=options.end!==false;var route="";for(var i=0;i<tokens.length;i++){var token=tokens[i];if(typeof token==="string"){route+=escapeString(token)}else{var prefix=escapeString(token.prefix);var capture="(?:"+token.pattern+")";keys.push(token);if(token.repeat){capture+="(?:"+prefix+capture+")*"}if(token.optional){if(!token.partial){capture="(?:"+prefix+"("+capture+"))?"}else{capture=prefix+"("+capture+")?"}}else{capture=prefix+"("+capture+")"}route+=capture}}var delimiter=escapeString(options.delimiter||"/");var endsWithDelimiter=route.slice(-delimiter.length)===delimiter;if(!strict){route=(endsWithDelimiter?route.slice(0,-delimiter.length):route)+"(?:"+delimiter+"(?=$))?"}if(end){route+="$"}else{route+=strict&&endsWithDelimiter?"":"(?="+delimiter+"|$)"}return attachKeys(new RegExp("^"+route,flags(options)),keys)}function pathToRegexp(path,keys,options){if(!isarray(keys)){options=keys||options;keys=[]}options=options||{};if(path instanceof RegExp){return regexpToRegexp(path,keys)}if(isarray(path)){return arrayToRegexp(path,keys,options)}return stringToRegexp(path,keys,options)}index$3.parse=parse_1;index$3.compile=compile_1;index$3.tokensToFunction=tokensToFunction_1;index$3.tokensToRegExp=tokensToRegExp_1;var Route=function Route(path,middleware){var this$1=this;this.middleware=flatMap(isArray(middleware)?middleware:[middleware],function(m){var pluginMiddleware=Router$1.plugins.reduce(function(ms,p){var _m=p(m);return _m?ms.concat(isArray(_m)?_m:[_m]):ms},[]);return pluginMiddleware.length>0?pluginMiddleware:m}).reduce(function(ms,m){if(isString(m)){this$1.component=m}else if(isPlainObject(m)){path=path.replace(/\/?!?$/,"/!");this$1.children=Object.entries(m).map(function(ref){var r=ref[0];var m=ref[1];return new Route(r,m)});if(!this$1.component){this$1.component="ko-component-router"}}else if(isFunction(m)){ms.push(m)}return ms},[]);if(path[path.length-1]==="!"){path=path.replace("!",":__child_path__(.*)?")}else{path=path.replace(/\(?\*\)?/,"(.*)")}this.path=path;this._keys=[];this._regexp=index$3(path,this._keys)};Route.prototype.matches=function matches(path){var this$1=this;var matches=this._regexp.exec(path);if(matches===null){return false}if(this.children){for(var i=0,list=this$1.children;i<list.length;i+=1){var childRoute=list[i];var childPath="/"+(matches[matches.length-1]||"");if(childRoute.matches(childPath)){return true}}return false}return true};Route.prototype.parse=function parse$$1(path){var this$1=this;var childPath;var params={};var matches=this._regexp.exec(path);for(var i=1,len=matches.length;i<len;++i){var k=this$1._keys[i-1];var v=matches[i]||"";if(k.name==="__child_path__"){childPath="/"+v}else{params[k.name]=v}}return[params,path.replace(new RegExp(childPath+"$"),""),childPath]};Route.createRoutes=function createRoutes(routes){return Object.entries(routes).map(function(ref){var r=ref[0];var m=ref[1];return new Route(r,m)})};var events={click:document.ontouchstart?"touchstart":"click",popstate:"popstate"};var onInit=[];var routers=[];var Router$1=function Router(params){var this$1=this;this.component=ko.observable();this.isNavigating=ko.observable(true);this.routes=Route.createRoutes(params.routes||{});Router.link(this);if(this.isRoot){Router.setConfig(params);(ref=this.routes).push.apply(ref,Route.createRoutes(Router.routes));document.addEventListener(events.click,Router.onclick);window.addEventListener(events.popstate,Router.onpopstate)}else if(this.$parent.ctx.route.children){(ref$1=this.routes).push.apply(ref$1,this.$parent.ctx.route.children)}this.passthrough=Object.entries(params).reduce(function(accum,ref){var k=ref[0];var v=ref[1];return k==="base"||k==="hashbang"||k==="routes"?accum:Object.assign(accum,(obj={},obj[k]=v,obj));var obj},{});this.update(this.getPathFromLocation(),false).then(function(){return onInit.forEach(function(r){return r(this$1)})});var ref;var ref$1};var prototypeAccessors={base:{},$parent:{},$parents:{},$child:{},$children:{}};var staticAccessors={head:{},tail:{},initialized:{}};prototypeAccessors.base.get=function(){return this.isRoot?Router$1.config.base+(Router$1.config.hashbang?"/#!":""):this.$parent.base+this.$parent.ctx.pathname};prototypeAccessors.$parent.get=function(){return routers[this.depth-1]};prototypeAccessors.$parents.get=function(){return routers.slice(0,this.depth).reverse()};prototypeAccessors.$child.get=function(){return routers[this.depth+1]};prototypeAccessors.$children.get=function(){return routers.slice(this.depth+1)};Router$1.prototype.update=function update(url,args){return new Promise(function($return,$error){var fromCtx,search,hash,path,route,params,pathname,childPath,shouldNavigate,toCtx,fromCtxChildren;fromCtx=this.ctx;if(isBool(args)){args={push:args}}else if(isUndefined(args)){args={}}if(isUndefined(args.push)){args.push=true}if(isUndefined(args.with)){args.with={}}var assign;assign=Router$1.parseUrl(url),search=assign.search,hash=assign.hash;path=Router$1.getPath(url);route=this.resolveRoute(path);if(!route){return $return(false)}var assign$1;assign$1=route.parse(path),params=assign$1[0],pathname=assign$1[1],childPath=assign$1[2];if(fromCtx&&fromCtx.pathname===pathname&&!args.force){if(this.$child){return this.$child.update(childPath+search+hash,args).then($return,$error)}else{return $return(false)}return $If_1.call(this)}function $If_1(){if(fromCtx){return fromCtx.runBeforeNavigateCallbacks().then(function($await_10){try{shouldNavigate=$await_10;if(shouldNavigate===false){return $return(false)}this.isNavigating(true);return $If_2.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_2(){history[args.push?"pushState":"replaceState"](history.state,document.title,this.base+path+search+hash);toCtx=new Context(Object.assign({},args.with,this.passthrough,{router:this,params:params,route:route,path:path,pathname:pathname}));if(fromCtx){return fromCtx.runBeforeDispose().then(function($await_11){try{return $If_3.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}function $If_3(){fromCtxChildren=fromCtx&&fromCtx.$children.reverse();return toCtx.runBeforeRender().then(function($await_12){try{this.ctx=toCtx;this.component(false);ko.tasks.runEarly();this.component(this.ctx.route.component);ko.tasks.runEarly();if(fromCtx){{var fromCtxChild,$iterator_fromCtxChild_5=[fromCtxChildren[Symbol.iterator]()];var $Loop_6_trampoline;return($Loop_6_trampoline=function(q){var this$1=this;while(q){if(q.then){return void q.then($Loop_6_trampoline,$error)}try{if(q.pop){if(q.length){return q.pop()?$Loop_6_exit.call(this$1):q}else{q=$Loop_6}}else{q=q.call(this$1)}}catch(_exception){return $error(_exception)}}}.bind(this))($Loop_6);function $Loop_6(){if(!($iterator_fromCtxChild_5[1]=$iterator_fromCtxChild_5[0].next()).done&&((fromCtxChild=$iterator_fromCtxChild_5[1].value)||true)){return fromCtxChild.runAfterDispose().then(function($await_13){try{return $Loop_6}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}else{return[1]}}}function $Loop_6_exit(){return fromCtx.runAfterDispose().then(function($await_14){try{return $If_4.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}}function $If_4(){return toCtx.runAfterRender().then(function($await_15){try{this.isNavigating(false);return $return(true)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}return $If_4.call(this)}catch($boundEx){return $error($boundEx)}}.bind(this),$error)}return $If_3.call(this)}return $If_2.call(this)}return $If_1.call(this)}.bind(this))};Router$1.prototype.resolveRoute=function resolveRoute(path){var this$1=this;var matchingRouteWithFewestDynamicSegments;var fewestMatchingSegments=Infinity;for(var rn in this$1.routes){var r=this$1.routes[rn];if(r.matches(path)){if(r._keys.length===0){return r}else if(fewestMatchingSegments===Infinity||r._keys.length<fewestMatchingSegments&&r._keys[0].pattern!==".*"){fewestMatchingSegments=r._keys.length;matchingRouteWithFewestDynamicSegments=r}}}return matchingRouteWithFewestDynamicSegments};Router$1.prototype.getPathFromLocation=function getPathFromLocation(){var path=location.pathname+location.search+location.hash;var baseWithOrWithoutHashbangRegexp=this.base.replace("#!","#?!?");return path.replace(new RegExp(baseWithOrWithoutHashbangRegexp,"i"),"")};Router$1.prototype.dispose=function dispose(){var this$1=this;Router$1.unlink();if(this.isRoot){document.removeEventListener(events.click,Router$1.onclick,false);window.removeEventListener(events.popstate,Router$1.onpopstate,false);this.ctx.runBeforeDispose().then(function(){return this$1.ctx.runAfterDispose()})}};Router$1.setConfig=function setConfig(ref){var base=ref.base;var hashbang=ref.hashbang;if(base){Router$1.config.base=base}if(hashbang){Router$1.config.hashbang=hashbang}};Router$1.use=function use(){var fns=[],len=arguments.length;while(len--)fns[len]=arguments[len];(ref=Router$1.middleware).push.apply(ref,fns);var ref};Router$1.usePlugin=function usePlugin(){var fns=[],len=arguments.length;while(len--)fns[len]=arguments[len];(ref=Router$1.plugins).push.apply(ref,fns);var ref};Router$1.useRoutes=function useRoutes(routes){Object.assign(Router$1.routes,routes)};Router$1.get=function get(i){return routers[i]};staticAccessors.head.get=function(){return routers[0]};staticAccessors.tail.get=function(){return routers[routers.length-1]};staticAccessors.initialized.get=function(){if(routers.length===0){return new Promise(function(resolve){return onInit.push(resolve)})}else{return Promise.resolve(Router$1.head)}};Router$1.update=function update(){var args=[],len=arguments.length;while(len--)args[len]=arguments[len];return new Promise(function($return,$error){return(ref=routers[0]).update.apply(ref,args).then($return,$error);var ref}.bind(this))};Router$1.link=function link(router){router.depth=routers.length;router.isRoot=router.depth===0;routers.push(router);router.$root=routers[0]};Router$1.unlink=function unlink(){routers.pop()};Router$1.onclick=function onclick(e){if(e.defaultPrevented){return}var el=e.target;while(el&&"A"!==el.nodeName){el=el.parentNode}if(!el||"A"!==el.nodeName){return}var pathname=el.pathname;var search=el.search;var hash=el.hash;if(hash===void 0)hash="";var path=(pathname+search+hash).replace(new RegExp(routers[0].base,"i"),"");var isValidRoute=Router$1.hasRoute(path);var isCrossOrigin=!Router$1.sameOrigin(el.href);var isDoubleClick=1!==Router$1.which(e);var isDownload=el.hasAttribute("download");var isEmptyHash=el.getAttribute("href")==="#";var isMailto=(el.getAttribute("href")||"").indexOf("mailto:")===0;var hasExternalRel=el.getAttribute("rel")==="external";var hasModifier=e.metaKey||e.ctrlKey||e.shiftKey;var hasOtherTarget=el.hasAttribute("target");if(!isValidRoute||isCrossOrigin||isDoubleClick||isDownload||isEmptyHash||isMailto||hasExternalRel||hasModifier||hasOtherTarget){return}Router$1.update(path);e.preventDefault()};Router$1.onpopstate=function onpopstate(e){Router$1.update(routers[0].getPathFromLocation(),false);e.preventDefault()};Router$1.canonicalizePath=function canonicalizePath(path){return path.replace(new RegExp("/?#?!?/?"),"/")};Router$1.parseUrl=function parseUrl(url){var parser=document.createElement("a");var b=routers[0].base.toLowerCase();if(b&&url.toLowerCase().indexOf(b)===0){url=url.replace(new RegExp(b,"i"),"")||"/"}parser.href=Router$1.canonicalizePath(url);return{hash:parser.hash,pathname:parser.pathname.charAt(0)==="/"?parser.pathname:"/"+parser.pathname,search:parser.search}};Router$1.getPath=function getPath(url){return Router$1.parseUrl(url).pathname};Router$1.hasRoute=function hasRoute(path){return!isUndefined(Router$1.head.resolveRoute(Router$1.getPath(path)))};Router$1.sameOrigin=function sameOrigin(href){var hostname=location.hostname;var port=location.port;var protocol=location.protocol;var origin=protocol+"//"+hostname;if(port){origin+=":"+port}return href&&href.indexOf(origin)===0};Router$1.which=function which(e){e=e||window.event;return null===e.which?e.button:e.which};Object.defineProperties(Router$1.prototype,prototypeAccessors);Object.defineProperties(Router$1,staticAccessors);Router$1.config={base:"",hashbang:false};Router$1.middleware=[];Router$1.plugins=[];Router$1.routes={};ko.bindingHandlers.path={init:function init(el,valueAccessor,allBindings,viewModel,bindingCtx){Router$1.initialized.then(function(){ko.tasks.schedule(function(){return ko.applyBindingsToNode(el,{attr:{href:ko.pureComputed(function(){return resolveHref(bindingCtx,ko.unwrap(valueAccessor()))})},css:{"active-path":ko.pureComputed(function(){return isActivePath(bindingCtx,ko.unwrap(valueAccessor()))})}})})})}};function resolveHref(bindingCtx,_path){var ref=parsePathBinding(bindingCtx,_path);var router=ref[0];var path=ref[1];return router.base+path}function isActivePath(bindingCtx,_path){var ref=parsePathBinding(bindingCtx,_path);var router=ref[0];var path=ref[1];return!router.isNavigating()&&(router.ctx.pathname||"/")==="/"+path.split("/")[1]}function parsePathBinding(bindingCtx,path){var router=getRouter(bindingCtx);if(path.indexOf("//")===0){path=path.replace("//","/");while(!router.isRoot){router=router.$parent}}else{if(path.indexOf("./")===0){path=path.replace("./","/");router=router.$child}while(path&&path.match(/\/?\.\./i)&&!router.isRoot){router=router.$parent;path=path.replace(/\/?\.\./i,"")}}return[router,path]}function getRouter(bindingCtx){while(!isUndefined(bindingCtx)){if(!isUndefined(bindingCtx.$router)){return bindingCtx.$router}bindingCtx=bindingCtx.$parentContext}return Router$1.get(0)}ko.components.register("ko-component-router",{synchronous:true,viewModel:{createViewModel:function(params){return new Router$1(unwrapParams(params))}},template:'<div data-bind="if: component">\n      <div class="ko-component-router-view" data-bind="__ko_component_router__"></div>\n    </div>'});ko.bindingHandlers.__ko_component_router__={init:function init(el,valueAccessor,allBindings,viewModel,bindingCtx){var $router=bindingCtx.$rawData;ko.applyBindingsToNode(el,{css:$router.component,component:{name:$router.component,params:$router.ctx}},bindingCtx.extend({$router:$router}));return{controlsDescendantBindings:true}}};function unwrapParams(params){function unwrapParam(p){if(ko.isObservable(params[p])){console.warn("\n        [ko-component-router] `params."+p+"` was passed in as an observable.\n        It willbe unwrapped, but changes will NOT be observed.\n    ");params[p]=ko.unwrap(params[p])}}unwrapParam("routes");unwrapParam("base");unwrapParam("hashbang");return params}return Router$1});